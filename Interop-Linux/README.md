# AUVSI SUAS 2020 FLU Interop Interface
Following the successful implementation of the 2019 System at the AUVSI SUAS competition, a new revision of the same system has been developed to optimise the uploading of objects, while also making implementation with the computer vision and Linux ground station considerably easier for the 2020 competition. Once complete, ideally, only one script will be required to be run, which will start the interop interface, interop server (if required for testing) and telemetry upload to the server. As of December 2019, these scripts are still in development.  

**NOTE: These files, commands, scripts and functions will only run on a Linux-based operating system, and have been tested on Ubuntu 18.04.**  

## Downloading the Interop System Code
In order to create a local copy of the github repository, run the following lines of code to install git and then clone the repository locally:  

`sudo apt-get install git`  
`git config --global user.email "your_email_here"`  
`git clone https://github.com/FlightLabsUNSW/FLU-AUVSI-Interop-System.git`  

You should then see the whole file structure in the 'FLU-AUVSI-Interop-System' folder in the home directory, and everything you need for this system is contained in these folders.  

In addition to this, you can run the 'git-functions.sh' script as below, which clones the local repository, using "download" as the input parameter for the script.  

`./FLU-AUVSI-Interop-System/Interop-Linux/bin/git-functions.sh download`  

It is good practice to do this every time before you start working locally if you are editing files, to ensure you have the latest version.  

## Setup & Installation Requirements
For ease of installation and setup on different computers, a startup/setup script has been developed, the 'flu-startup-system.sh' file. To be able to run the startup script, run the following lines of code from the root:  

`cd FLU-AUVSI-Interop-System/Interop-Linux`  
`chmod u+x ./bin/flu-startup-system.sh`  
`./bin/flu-startup-system.sh setup`  

The setup after the file path is extremely important to ensure the script runs the correct functions for setup of the server and running of the FLU Interop Interface.  

## User Input Requirements
To easily collate user-generated information and not require constant re-inputting of data on every upload, the "mission-params.json" file is used. In this file, the following parameters can be configured:  

- ID: Used for debugging only  
- IP: Raw IP address of the interop server (i.e. 192.168.1.16)  
- Mission ID: Mission ID given to the team (if unsure before comp, use 1)  
- Port: Raw port of the interop server (i.e. 8000)  
- Username & Password: Login details for the interop server  
- Device IP: Full IP address (including port) for telemetry output from MAVProxy (i.e. 192.168.1.16:14551)  
- Comport: Serial USB port where telemetry is going into the computer system (i.e. /dev/ttyUSB0)  

These parameters must be updated prior to starting the system, and **MUST** be set by the user and are not automatically generated by the FLU interop system.  

## Main Scripts
These scripts contain the main code bodies and function calling, and are named 'flu-main-******.sh' in the Interop-Linux bin folder. There are currently two main scripts.  

1. **flu-main-interop.sh** - Main code body associated with the interaction with the interop server. Includes uploading of objects and images, login process, extraction of mission details, and watching for files to come from the plane to the ground station.  
2. **flu-main-mavproxy.sh** - Main code body associated with the porting of telemetry to multiple different sources, including the interop system, QGroundControl ground station, and any other network locations where required. Is required to be a script to run in an extra terminal from another script.  
3. **flu-main-server.sh** - Main code body associated with starting the interop server locally. This runs the startServer function, and was required to run in an extra terminal like -mavproxy script above.  

## Function Scripts
These scripts contain the main functions associated with the main scripts, and are named 'flu-functions-******.sh' in the Interop-Linux bin folder. There are currently two function scripts, along with a git-functions script for source control.  

1. **flu-functions-interop.sh** - Functions that are used in the flu-main-interop.sh script, primarily used to clean up the main scripts and make debugging easier.  
2. **flu-functions-server.sh** - Functions that are used in the setup of the system, along with starting and upgrading the interop server, as well as starting the telemetry stream to the interop server.  

## File Structure
The file structure is extremely important, as majority of the locations are hard-coded into the system. Please **DO NOT** change the file structure of the Github unless it has been discussed and changed in the code. All of the main code is in the 'bin' folder, and all of the scripts reside in this folder.  

Within the 'bin' folder, there are three main folders, 'archive', 'plane-data', and 'test-data', with their functions described below:  

1. **archive** - All files, after being uploaded to the interop server, end up in this folder for easy checking of uploading and verifying correct objects. This folder should be clear of zip, json, jpg, and png files before starting.  
2. **plane-data** - Folder where the zip folders from the plane will arrive in, and is being watched by the system for the arrival of zip folders.  
3. **test-data** - Folder for the storage of dummy objects in zip folders, containing a json and jpg file. If you are editing the JSON files in the Test-Data zip folders, be sure to follow the API at the following link: https://github.com/auvsi-suas/interop/blob/master/proto/interop_api.proto  

## Debugging
Most debugging can be done in the command line interface, with reasonable error codes and locations presented in the case of failures in the system. A common error that has been run into so far:  

1. **Denied permissions for running scripts** - run the following line of code to allow the running of a particular script:  
`chmod u+x /path-to-source/filename.extension`  
2. **Terminals appearing & disappearing** - check that telemetry radio is plugged in first and is attached to a USB port. There will be three terminals open at the competition (four during testing with server).  

This section will be expanded upon when other running errors are identified and mitigated, either in code or through a short input as above.  

## Source Control
If you are editing local files, instead of having to copy/paste or reupload files individually, git can be used to add, commit and push files directly to the master branch from local.  

`cd FLU-AUVSI-Interop-System`  
`git add Interop-Linux`  
`git commit`  

A screen will appear, prompting you to add a commit message, please make it concise and descriptive. When you are done, press Ctrl+X, type 'y', then press Enter to confirm the commit. To finish, run:  

`git push`  

Instead of running these four lines individually, the 'git-functions.sh' script can be run again using "upload" as the input parameter.  

`./FLU-AUVSI-Interop-System/Interop-Linux/bin/git-functions.sh upload`  

You will be required to log in to push commits to the master branch, so be sure to have access to the FLU github and know your username and password.  

## Dodgy Stuff...
To make for easier running of everything and requiring no password inputs, follow the instructions on the following link (second answer by jiminikiz):  

https://askubuntu.com/questions/192050/how-to-run-sudo-command-with-no-password  

This is kinda dodgy, and we might look into a less dodgy way which still requires the password but only once at the beginning of the startup script, but this for now makes testing and startup considerably faster than having to enter the same password multiple times.  

## Full Interop System Use & Testing
While each of the scripts mentioned above will run independently, the startup script has been developed to make the startup and observation of each process easy and traceable. To start the full FLU Interop System, **INCLUDING** the interop server, run the following lines of code:  

`cd FLU-AUVSI-Interop-System/Interop-Linux`  
`chmod u+x ./bin/flu-startup-system.sh`  
`./bin/flu-startup-system.sh start`  

For the AUVSI SUAS competition, run the following line instead of the third line above:  

`./bin/flu-startup-system.sh comp`  

**NOTE:** Be aware of your IP address and any user inputs, and ensure that these are up to date prior to starting the system - errors galore await you if you forget...  

### Interop Server Judging Interface
For the documentation in the 2019 competition, a YouTube video explaining the interop system was created using a series of screen videos, and can be found at the following link:  

https://www.youtube.com/watch?v=nwT3D7kThdo  

Refer to the following timestamps for information on the respective parts of the Interop Server used for judging (this knowledge is good to have but not necessary by any means; most teams at the competition had no idea that they could build the server and test using it...):  

- 2:15-2:40 >>> Interop server login  
- 14:00-16:55 >>> Telemetry receiving screen, ODLCs review, team evaluation, editing interop server data  

Be aware that the server has since been updated with very minor interface changes, so using the current version will look slightly different to the interface seen in the video.  

### Viewing Live KMZ/KML Data
**Unverified, has not been tested yet on full missions due to time restrictions before AUVSI 2019**  

### Automatic Mission Evaluation
**Unverified, has not been tested yet on full missions due to time restrictions before AUVSI 2019**  

## Code Notes
System: Linux (Ubuntu 18.04)  
Language: Shell  
Developer: Marco Alberto  
Most Recent Update: 21 December 2019  
